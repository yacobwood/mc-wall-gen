<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blockwork</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0; padding: 0;
      background: #111; color: #d4d4d4;
      font-family: 'VT323', monospace; font-size: 18px;
      display: flex; height: 100vh; overflow: hidden;
    }

    /* === SIDEBAR === */
    #sidebar {
      width: 290px; min-width: 290px;
      background: #1e1e1e; border-right: 2px solid #333;
      display: flex; flex-direction: column;
      overflow-y: auto; overflow-x: hidden;
    }
    #sidebar::-webkit-scrollbar { width: 6px; }
    #sidebar::-webkit-scrollbar-track { background: #1a1a1a; }
    #sidebar::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

    .sidebar-header {
      background: linear-gradient(180deg, #1a2b0e 0%, #161616 100%);
      border-bottom: 2px solid #3a5a14;
      padding: 14px 16px 12px; flex-shrink: 0;
    }
    .sidebar-header h1 {
      margin: 0; font-size: 24px; color: #8ecf3f; letter-spacing: 2px;
      text-shadow: 0 0 18px rgba(100,200,30,0.35);
    }
    .sidebar-header p { margin: 4px 0 0; font-size: 14px; color: #666; }

    .sidebar-section { padding: 12px 16px; border-bottom: 1px solid #2a2a2a; }
    .sidebar-section h2 { margin: 0 0 10px; font-size: 16px; color: #aaa; text-transform: uppercase; letter-spacing: 2px; }

    /* === CONTROLS === */
    .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .control-group { display: flex; flex-direction: column; gap: 3px; }
    .control-group label { font-size: 14px; color: #888; }
    .control-group input[type="number"] {
      background: #2a2a2a; border: 1px solid #444;
      color: #d4d4d4; font-family: 'VT323', monospace; font-size: 20px;
      padding: 4px 8px; width: 100%; border-radius: 3px; outline: none;
    }
    .control-group input[type="number"]:focus { border-color: #5a8a20; }

    .block-size-row { display: flex; flex-direction: column; gap: 4px; margin-top: 8px; }
    .block-size-label-row { display: flex; justify-content: space-between; align-items: center; }
    .block-size-label-row label { font-size: 14px; color: #888; }
    #blockSizeVal { font-size: 16px; color: #7dc33a; }

    input[type="range"] {
      -webkit-appearance: none; appearance: none;
      width: 100%; height: 4px; background: #333; border-radius: 2px; outline: none; cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none;
      width: 14px; height: 14px; border-radius: 2px; background: #5a8a20; cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb:hover { background: #7dc33a; }

    /* === BUTTONS === */
    .btn-row { display: flex; flex-direction: column; gap: 6px; }
    button {
      font-family: 'VT323', monospace; font-size: 20px;
      border: none; cursor: pointer; padding: 8px 12px;
      border-radius: 4px; transition: background 0.12s, transform 0.05s, filter 0.05s; letter-spacing: 1px;
    }
    button:active { transform: translateY(1px); }
    .btn-primary {
      background: linear-gradient(180deg, #5a8a20 0%, #4a7a18 100%);
      color: #d4ffaa; border-bottom: 3px solid #2a4e0e;
    }
    .btn-primary:hover { background: linear-gradient(180deg, #6a9a28 0%, #5a8a20 100%); }
    .btn-secondary { background: #282828; color: #999; border-bottom: 3px solid #191919; }
    .btn-secondary:hover { background: #343434; color: #ccc; }
    .small-btn-row { display: flex; gap: 6px; }
    .small-btn-row button { flex: 1; font-size: 16px; padding: 5px 8px; }

    @keyframes btnConfirm {
      0%   { filter: brightness(2.2); }
      100% { filter: brightness(1); }
    }
    .btn-confirm { animation: btnConfirm 0.45s ease-out; }

    .seed-row { display: flex; gap: 6px; align-items: center; margin-top: 4px; }
    .seed-label { font-size: 14px; color: #777; white-space: nowrap; }
    #seedInput {
      background: #1a1a1a; border: 1px solid #333;
      color: #7dc33a; font-family: 'VT323', monospace; font-size: 18px;
      padding: 3px 8px; width: 0; flex: 1; border-radius: 3px; outline: none; letter-spacing: 1px;
    }
    #seedInput:focus { border-color: #5a8a20; }

    /* === PRESET SELECT === */
    select {
      background: #2a2a2a; border: 1px solid #444;
      color: #d4d4d4; font-family: 'VT323', monospace; font-size: 18px;
      padding: 5px 8px; width: 100%; border-radius: 3px; outline: none; cursor: pointer;
    }
    select:focus { border-color: #5a8a20; }

    /* === PALETTE UI === */
    .category { border-bottom: 1px solid #222; }
    .category-header {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 16px; cursor: pointer; user-select: none;
      background: #1a1a1a; font-size: 15px; color: #888; letter-spacing: 1px;
      border-left: 3px solid transparent; transition: border-color 0.15s, color 0.15s;
    }
    .category-header:hover { background: #202020; color: #bbb; border-left-color: #4a7a18; }
    .cat-arrow { font-size: 11px; color: #555; }
    .cat-count { margin-left: auto; font-size: 13px; color: #5a8a20; }
    .block-list.collapsed { display: none; }
    .subcat-header {
      padding: 5px 16px 3px 18px; font-size: 11px; color: #4a6a22;
      letter-spacing: 1.5px; text-transform: uppercase;
      border-top: 1px solid #252525; margin-top: 2px;
    }
    .subcat-header:first-child { border-top: none; margin-top: 0; }

    /* === SELECTED SUMMARY === */
    #selectedSummary {
      display: none; padding: 8px 14px 10px;
      border-bottom: 1px solid #2a2a2a; background: #191919;
    }
    .summary-title { font-size: 13px; color: #555; letter-spacing: 1px; margin-bottom: 6px; }
    .summary-chips { display: flex; flex-direction: column; gap: 5px; }
    .summary-row { display: flex; flex-direction: column; gap: 2px; }
    .summary-row-top { display: flex; align-items: center; gap: 6px; }
    .summary-preview { display: block; flex-shrink: 0; image-rendering: pixelated; border-radius: 2px; }
    .summary-row-name {
      flex: 1; font-size: 14px; color: #bbb;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .summary-slider { width: 100%; }

    /* Block row — vertical layout */
    .block-row {
      display: flex; flex-direction: column;
      padding: 5px 14px 5px 18px;
    }
    .block-row:hover { background: #252525; }

    .block-row-top {
      display: flex; align-items: center; gap: 7px; cursor: pointer;
    }

    .block-preview {
      width: 24px; height: 24px; flex-shrink: 0;
      image-rendering: pixelated; border: 1px solid #333;
    }
    .block-row input[type="checkbox"] {
      accent-color: #5a8a20; width: 14px; height: 14px; flex-shrink: 0; cursor: pointer;
    }
    .block-name {
      flex: 1; font-size: 16px; color: #bbb;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .block-row.selected .block-name { color: #d4d4d4; }

    .pct-display {
      font-size: 16px; color: #7dc33a;
      min-width: 38px; text-align: right; flex-shrink: 0;
    }

    /* Lock button */
    .lock-btn {
      background: none; border: none;
      padding: 0 3px; line-height: 1;
      color: #3a3a3a; cursor: pointer; flex-shrink: 0;
      transition: color 0.15s; display: none;
      align-items: center;
    }
    .lock-btn svg { display: block; }
    .block-row.selected .lock-btn, .summary-row .lock-btn { display: flex; }
    .lock-btn:hover { color: #777; }
    .lock-btn.locked { color: #c8902a; }
    .lock-btn:active { transform: none; }

    /* Percentage slider row */
    .block-slider-wrap {
      display: none;
      padding-left: 45px;
      margin-top: 4px;
      align-items: center;
      gap: 0;
    }
    .block-row.selected .block-slider-wrap { display: flex; }

    .pct-slider {
      flex: 1; height: 4px;
      accent-color: #5a8a20;
    }
    .pct-slider::-webkit-slider-thumb { background: #5a8a20; }

    /* === CANVAS AREA === */
    #canvas-area {
      flex: 1; overflow: auto;
      display: flex; flex-direction: column; align-items: flex-start;
      padding: 20px; background: #111;
    }
    #canvas-area::-webkit-scrollbar { width: 8px; height: 8px; }
    #canvas-area::-webkit-scrollbar-track { background: #111; }
    #canvas-area::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    #canvas-toolbar { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .canvas-info { font-size: 15px; color: #555; }
    #wall-canvas {
      image-rendering: pixelated; image-rendering: crisp-edges;
      display: block; border: 2px solid #2a2a2a;
      box-shadow: 0 6px 28px rgba(0,0,0,0.6);
    }
    #empty-msg { display: none; color: #555; font-size: 20px; padding: 40px; }
    .spacer { height: 4px; }
    .toggle-row {
      display: flex; align-items: center; gap: 8px;
      margin-top: 8px; font-size: 14px; color: #777; cursor: pointer;
    }
    .toggle-row input { cursor: pointer; accent-color: #5a8a20; }
  </style>
</head>
<body>

<aside id="sidebar">
  <div class="sidebar-header">
    <h1>Blockwork</h1>
    <p>Minecraft wall designer by Yacobwood</p>
  </div>

  <div class="sidebar-section">
    <h2>Dimensions</h2>
    <div class="controls-grid">
      <div class="control-group">
        <label>Width (blocks)</label>
        <input type="number" id="widthInput" value="12" min="1" max="64">
      </div>
      <div class="control-group">
        <label>Height (blocks)</label>
        <input type="number" id="heightInput" value="8" min="1" max="32">
      </div>
    </div>
    <div class="block-size-row">
      <div class="block-size-label-row">
        <label>Zoom</label>
        <span id="blockSizeVal">3×</span>
      </div>
      <input type="range" id="blockSizeRange" min="0" max="4" value="2" step="1">
    </div>
    <label class="toggle-row">
      <input type="checkbox" id="coordsToggle" checked>
      <span>Show row &amp; column numbers</span>
    </label>
  </div>

  <div class="sidebar-section">
    <div class="btn-row">
      <button class="btn-primary" id="btnRandomize">&#x1F3B2; Randomize Wall</button>
      <button class="btn-secondary" id="btnExport">&#x1F4BE; Export PNG</button>
    </div>
    <div class="spacer"></div>
    <div class="seed-row">
      <span class="seed-label">Seed:</span>
      <input type="text" id="seedInput" placeholder="hex seed" maxlength="8" spellcheck="false">
    </div>
  </div>

  <div class="sidebar-section">
    <h2>Presets</h2>
    <select id="presetSelect">
      <option value="">— load a preset —</option>
      <optgroup label="Classic">
        <option value="dungeon">Dungeon / Ruins</option>
        <option value="nether_fortress">Nether Fortress</option>
        <option value="deepslate_cave">Deep Cave</option>
        <option value="desert_temple">Desert Temple</option>
        <option value="ocean_monument">Ocean Monument</option>
        <option value="polished_mix">Polished Mix</option>
        <option value="mossy_ruin">Mossy Ruin</option>
      </optgroup>
      <optgroup label="Community Palettes">
        <option value="back_from_the_mines">Back from the Mines</option>
        <option value="overgrown_path">Overgrown Path</option>
        <option value="woodcutter">Woodcutter</option>
        <option value="grove_of_ashes">Grove of Ashes</option>
        <option value="ghost_valley">Ghost Valley</option>
        <option value="italian_path">Italian Path</option>
        <option value="undergrove">Undergrove</option>
        <option value="barrel_roll">Barrel Roll</option>
        <option value="old_garage">Old Garage</option>
        <option value="rusty_roof">Rusty Roof</option>
        <option value="warmer_wood">Warmer Wood</option>
        <option value="coal_house">Coal House</option>
        <option value="magical_fungi">Magical Fungi</option>
        <option value="candy_leaves">Candy Leaves</option>
        <option value="cabin_shower">Cabin Shower</option>
        <option value="steampunk_blacksmith">Steampunk Blacksmith</option>
        <option value="mumbo_mountain">Mumbo Mountain</option>
        <option value="meadow_in_the_city">Meadow in the City</option>
      </optgroup>
      <optgroup label="Themed">
        <option value="end_city">End City</option>
        <option value="ice_palace">Ice Palace</option>
        <option value="basalt_delta">Basalt Delta</option>
        <option value="tuff_tower">Tuff Tower</option>
        <option value="mushroom_house">Mushroom House</option>
        <option value="golden_palace">Golden Palace</option>
      </optgroup>
    </select>
  </div>

  <div class="sidebar-section" style="padding-bottom:0; border-bottom:none;">
    <h2>Block Palette</h2>
  </div>
  <div id="selectedSummary">
    <div class="summary-title">Selected</div>
    <div class="summary-chips" id="summaryChips"></div>
  </div>
  <div id="paletteContainer"></div>
  <div style="height:16px; flex-shrink:0;"></div>
</aside>

<main id="canvas-area">
  <div id="canvas-toolbar">
    <span class="canvas-info" id="canvasInfo"></span>
    <span class="canvas-info" id="texStatus" style="color:#555;"></span>
  </div>
  <div id="empty-msg">Select at least one block from the palette.</div>
  <canvas id="wall-canvas"></canvas>
</main>

<script>
// ============================================================
// RNG
// ============================================================
function mulberry32(seed) {
  seed = seed >>> 0;
  return function() {
    seed = (seed + 0x6D2B79F5) >>> 0;
    let t = Math.imul(seed ^ (seed >>> 15), 1 | seed);
    t = (t + Math.imul(t ^ (t >>> 7), 61 | t)) ^ t;
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

// ============================================================
// PIXEL HELPERS
// ============================================================
const S = 16;
function clamp(v) { return v < 0 ? 0 : v > 255 ? 255 : Math.round(v); }
function sp(d, x, y, r, g, b) {
  if (x < 0 || x >= S || y < 0 || y >= S) return;
  const i = (y * S + x) * 4;
  d[i] = r; d[i+1] = g; d[i+2] = b; d[i+3] = 255;
}

// ============================================================
// TEXTURE GENERATORS
// ============================================================
function flatNoise(rng, r, g, b, n) {
  const d = new Uint8ClampedArray(S * S * 4);
  for (let i = 0; i < S * S; i++) {
    const v = (rng() - 0.5) * 2 * n;
    d[i*4] = clamp(r+v); d[i*4+1] = clamp(g+v); d[i*4+2] = clamp(b+v); d[i*4+3] = 255;
  }
  return d;
}

function specksNoise(rng, r, g, b, sr, sg, sb, density, n) {
  const d = new Uint8ClampedArray(S * S * 4);
  for (let i = 0; i < S * S; i++) {
    const v = (rng() - 0.5) * 2 * n;
    if (rng() < density) {
      d[i*4] = clamp(sr+v); d[i*4+1] = clamp(sg+v); d[i*4+2] = clamp(sb+v);
    } else {
      d[i*4] = clamp(r+v); d[i*4+1] = clamp(g+v); d[i*4+2] = clamp(b+v);
    }
    d[i*4+3] = 255;
  }
  return d;
}

const COBBLE_SEED_CENTERS = [[3,3],[11,2],[14,5],[5,9],[13,10],[8,6],[2,12],[11,13],[6,14]];
function cobbleGen(rng, r, g, b) {
  const d = new Uint8ClampedArray(S * S * 4);
  const centers = COBBLE_SEED_CENTERS.map(([cx,cy]) => [cx+(rng()-0.5)*2.2, cy+(rng()-0.5)*2.2]);
  const sv = centers.map(() => (rng()-0.5)*32);
  const noise = Float32Array.from({length: S*S}, () => (rng()-0.5)*28);
  for (let y = 0; y < S; y++) for (let x = 0; x < S; x++) {
    let d1=Infinity, d2=Infinity, mi=0;
    for (let ci=0; ci<centers.length; ci++) {
      const [cx,cy]=centers[ci], dist=(x-cx)**2+(y-cy)**2;
      if (dist<d1){d2=d1;d1=dist;mi=ci;}else if(dist<d2){d2=dist;}
    }
    const border = Math.sqrt(d2)-Math.sqrt(d1);
    const ni = noise[y*S+x];
    const v = border<1.7 ? clamp(r-52+ni*0.4) : clamp(r+sv[mi]+ni);
    sp(d,x,y,v,v,v);
  }
  return d;
}

function bricksGen(rng, br, bg, bb, mr, mg, mb, brickW=7, brickH=3, noiseAmt=14) {
  const d = new Uint8ClampedArray(S * S * 4);
  const rowH = brickH + 1;
  for (let y=0; y<S; y++) {
    const rowIdx = Math.floor(y/rowH);
    const isHMortar = (y % rowH) === 0;
    const offset = (rowIdx%2) * Math.ceil(brickW/2);
    for (let x=0; x<S; x++) {
      const ax = (x+offset)%S;
      const isVMortar = (ax%(brickW+1)) === 0;
      const v = (rng()-0.5)*2*noiseAmt;
      if (isHMortar||isVMortar) sp(d,x,y,clamp(mr+v*0.5),clamp(mg+v*0.5),clamp(mb+v*0.5));
      else sp(d,x,y,clamp(br+v),clamp(bg+v),clamp(bb+v));
    }
  }
  return d;
}

function grainGen(rng, r, g, b, n) {
  const d = new Uint8ClampedArray(S * S * 4);
  const rb = Float32Array.from({length:S}, () => (rng()-0.5)*n);
  for (let y=0; y<S; y++) for (let x=0; x<S; x++) {
    const v = (rng()-0.5)*n*0.6 + rb[y];
    sp(d,x,y,clamp(r+v),clamp(g+v),clamp(b+v));
  }
  return d;
}

function sandstoneGen(rng, r, g, b) {
  const d = new Uint8ClampedArray(S * S * 4);
  for (let y=0; y<S; y++) {
    const bs = Math.sin(y*0.9)*14 + (rng()-0.5)*10;
    for (let x=0; x<S; x++) {
      const v=(rng()-0.5)*10;
      sp(d,x,y,clamp(r+bs+v),clamp(g+bs+v),clamp(b+bs+v));
    }
  }
  return d;
}

function prismarineGen(rng) {
  const d = new Uint8ClampedArray(S * S * 4);
  for (let y=0; y<S; y++) for (let x=0; x<S; x++) {
    const w=Math.sin(x*1.1+y*0.8+rng()*0.5)*18, v=(rng()-0.5)*20;
    sp(d,x,y,clamp(102+w+v),clamp(162+w*0.7+v*0.6),clamp(147+w*0.8+v*0.7));
  }
  return d;
}

function darkPrismarineGen(rng) {
  const d = new Uint8ClampedArray(S * S * 4);
  for (let y=0; y<S; y++) for (let x=0; x<S; x++) {
    const w=Math.sin(x*0.9+y*1.2+rng()*0.4)*10, v=(rng()-0.5)*14;
    sp(d,x,y,clamp(52+w+v),clamp(86+w*0.7+v*0.6),clamp(70+w*0.8+v*0.7));
  }
  return d;
}

function smoothStoneGen(rng) {
  const d = flatNoise(rng, 118, 118, 118, 8);
  for (let x=0; x<S; x++) {
    const sh=(v)=>clamp(v*0.55);
    let i=x*4; d[i]=sh(d[i]);d[i+1]=sh(d[i+1]);d[i+2]=sh(d[i+2]);
    i=((S-1)*S+x)*4; d[i]=sh(d[i]);d[i+1]=sh(d[i+1]);d[i+2]=sh(d[i+2]);
  }
  for (let y=1; y<S-1; y++) {
    const sh=(v)=>clamp(v*0.55);
    let i=(y*S)*4; d[i]=sh(d[i]);d[i+1]=sh(d[i+1]);d[i+2]=sh(d[i+2]);
    i=(y*S+S-1)*4; d[i]=sh(d[i]);d[i+1]=sh(d[i+1]);d[i+2]=sh(d[i+2]);
  }
  return d;
}

function woodPlanks(rng, r, g, b) {
  const d = new Uint8ClampedArray(S * S * 4);
  const ps = Array.from({length:4}, () => (rng()-0.5)*14);
  for (let y=0; y<S; y++) {
    const isEdge = (y%4)===0, shade=isEdge?0.68:1.0, pv=ps[Math.floor(y/4)%4];
    for (let x=0; x<S; x++) {
      const gx=(rng()-0.5)*14;
      sp(d,x,y,clamp((r+pv+gx)*shade),clamp((g+pv+gx)*shade),clamp((b+pv+gx)*shade));
    }
  }
  return d;
}

function leavesGen(rng, r, g, b) {
  const d = new Uint8ClampedArray(S * S * 4);
  for (let y=0; y<S; y++) for (let x=0; x<S; x++) {
    const v=(rng()-0.5)*35, dark=rng()<0.13?0.52:1.0;
    sp(d,x,y,clamp((r+v)*dark),clamp((g+v)*dark),clamp((b+v)*dark));
  }
  return d;
}

function azaleaLeavesGen(rng) {
  const d = leavesGen(rng, 55, 100, 28);
  for (let i=0; i<S*S; i++) {
    if (rng()<0.09) {
      d[i*4]=clamp(190+(rng()-0.5)*30); d[i*4+1]=clamp(90+(rng()-0.5)*20); d[i*4+2]=clamp(130+(rng()-0.5)*20);
    }
  }
  return d;
}

function grassBlockGen(rng) {
  const d = new Uint8ClampedArray(S * S * 4);
  for (let y=0; y<S; y++) for (let x=0; x<S; x++) {
    const v=(rng()-0.5)*20;
    if (y<3) sp(d,x,y,clamp(94+v),clamp(160+v),clamp(52+v));
    else if (y<5) { const t=(y-3)/2; sp(d,x,y,clamp(94+(40)*t+v),clamp(160+(-64)*t+v),clamp(52+(15)*t+v)); }
    else sp(d,x,y,clamp(134+v),clamp(96+v),clamp(67+v));
  }
  return d;
}

function oxidizedCopperGen(rng) {
  const d = new Uint8ClampedArray(S * S * 4);
  for (let y=0; y<S; y++) for (let x=0; x<S; x++) {
    const v=(rng()-0.5)*22, patch=Math.sin(x*0.7+y*1.1)*8;
    sp(d,x,y,clamp(82+v+patch*0.3),clamp(176+v*0.7+patch),clamp(138+v*0.8+patch*0.6));
  }
  return d;
}

function crimsonNyliumGen(rng) {
  const d = new Uint8ClampedArray(S * S * 4);
  for (let i=0; i<S*S; i++) {
    const v=(rng()-0.5)*16;
    if (rng()<0.08) { d[i*4]=clamp(60+v); d[i*4+1]=clamp(180+v); d[i*4+2]=clamp(148+v); }
    else { d[i*4]=clamp(92+v); d[i*4+1]=clamp(20+v*0.5); d[i*4+2]=clamp(22+v*0.5); }
    d[i*4+3]=255;
  }
  return d;
}

function logBarkGen(rng, r, g, b) {
  // Vertical grain for bark side face
  const d = new Uint8ClampedArray(S * S * 4);
  const cols = Float32Array.from({length: S}, () => (rng()-0.5)*24);
  for (let y = 0; y < S; y++) for (let x = 0; x < S; x++) {
    const v = cols[x] + (rng()-0.5)*8;
    sp(d, x, y, clamp(r+v), clamp(g+v*0.72), clamp(b+v*0.5));
  }
  return d;
}

function logTopGen(rng, r, g, b) {
  // Concentric rings for log end-grain
  const d = new Uint8ClampedArray(S * S * 4);
  for (let y = 0; y < S; y++) for (let x = 0; x < S; x++) {
    const dist = Math.sqrt((x-7.5)**2 + (y-7.5)**2);
    const ring = Math.sin(dist * 1.9) * 0.5 + 0.5;
    const v = (rng()-0.5)*14;
    const rv = ring * 22;
    sp(d, x, y, clamp(r+v+rv*0.9), clamp(g+v*0.8+rv*0.75), clamp(b+v*0.6+rv*0.5));
  }
  return d;
}

function applyMoss(d, rng, intensity) {
  for (let i=0; i<S*S; i++) {
    if (rng()<intensity) {
      const avg=(d[i*4]+d[i*4+1]+d[i*4+2])/3;
      if (avg>62) {
        const str=0.45+rng()*0.55;
        d[i*4]=clamp(d[i*4]*(1-str*0.5)+18*str);
        d[i*4+1]=clamp(d[i*4+1]*(1-str*0.2)+92*str);
        d[i*4+2]=clamp(d[i*4+2]*(1-str*0.6)+14*str);
      }
    }
  }
}

function applyCracks(d, rng) {
  const n=2+Math.floor(rng()*3);
  for (let c=0; c<n; c++) {
    let x=Math.floor(rng()*S), y=Math.floor(rng()*S);
    for (let s=0; s<3+Math.floor(rng()*7); s++) {
      if (x>=0&&x<S&&y>=0&&y<S) {
        const i=(y*S+x)*4; d[i]=d[i]*0.25|0; d[i+1]=d[i+1]*0.25|0; d[i+2]=d[i+2]*0.25|0;
      }
      x+=Math.floor((rng()-0.35)*3); y+=Math.floor((rng()-0.25)*3);
    }
  }
}

// ============================================================
// BLOCK DEFINITIONS
// ============================================================
const BLOCKS = [
  // ---- STONE ----
  {id:'stone',                  name:'Stone',                  cat:'Stone',    sub:'Natural', gen:r=>flatNoise(r,120,120,120,16)},
  {id:'cobblestone',            name:'Cobblestone',            cat:'Stone',    sub:'Natural', gen:r=>cobbleGen(r,100,100,100)},
  {id:'mossy_cobblestone',      name:'Mossy Cobblestone',      cat:'Stone',    sub:'Natural', gen:r=>{const d=cobbleGen(r,100,100,100);applyMoss(d,r,0.38);return d;}},
  {id:'smooth_stone',           name:'Smooth Stone',           cat:'Stone',    sub:'Natural', gen:r=>smoothStoneGen(r)},
  {id:'tuff',                   name:'Tuff',                   cat:'Stone',    sub:'Natural', gen:r=>flatNoise(r,105,108,100,16)},
  {id:'calcite',                name:'Calcite',                cat:'Stone',    sub:'Natural', gen:r=>flatNoise(r,218,218,215,8)},
  {id:'andesite',               name:'Andesite',               cat:'Stone',    sub:'Polished', gen:r=>specksNoise(r,130,130,130,58,58,58,0.09,16)},
  {id:'polished_andesite',      name:'Polished Andesite',      cat:'Stone',    sub:'Polished', gen:r=>flatNoise(r,135,135,135,7)},
  {id:'diorite',                name:'Diorite',                cat:'Stone',    sub:'Polished', gen:r=>specksNoise(r,202,202,202,88,88,88,0.13,11)},
  {id:'polished_diorite',       name:'Polished Diorite',       cat:'Stone',    sub:'Polished', gen:r=>flatNoise(r,198,198,198,6)},
  {id:'granite',                name:'Granite',                cat:'Stone',    sub:'Polished', gen:r=>specksNoise(r,148,103,86,88,48,38,0.1,18)},
  {id:'polished_granite',       name:'Polished Granite',       cat:'Stone',    sub:'Polished', gen:r=>flatNoise(r,152,108,88,9)},
  {id:'polished_tuff',          name:'Polished Tuff',          cat:'Stone',    sub:'Tuff', gen:r=>flatNoise(r,110,112,106,8)},
  {id:'tuff_bricks',            name:'Tuff Bricks',            cat:'Stone',    sub:'Tuff', gen:r=>bricksGen(r,108,112,104,72,76,68)},
  {id:'chiseled_tuff',          name:'Chiseled Tuff',          cat:'Stone',    sub:'Tuff', gen:r=>bricksGen(r,105,108,100,70,74,66,14,6)},
  {id:'chiseled_tuff_bricks',   name:'Chiseled Tuff Bricks',   cat:'Stone',    sub:'Tuff', gen:r=>bricksGen(r,108,112,104,72,76,68,7,3)},
  {id:'stone_bricks',           name:'Stone Bricks',           cat:'Stone',    sub:'Brick', gen:r=>bricksGen(r,122,122,122,76,76,76)},
  {id:'mossy_stone_bricks',     name:'Mossy Stone Bricks',     cat:'Stone',    sub:'Brick', gen:r=>{const d=bricksGen(r,122,122,122,76,76,76);applyMoss(d,r,0.33);return d;}},
  {id:'cracked_stone_bricks',   name:'Cracked Stone Bricks',   cat:'Stone',    sub:'Brick', gen:r=>{const d=bricksGen(r,122,122,122,76,76,76);applyCracks(d,r);return d;}},
  {id:'chiseled_stone_bricks',  name:'Chiseled Stone Bricks',  cat:'Stone',    sub:'Brick',
    gen:r=>{
      const d=bricksGen(r,118,118,118,72,72,72,14,6);
      for(let y=0;y<S;y++)for(let x=0;x<S;x++){
        const dist=Math.sqrt((x-7.5)**2+(y-7.5)**2);
        if(dist<3.5){const i=(y*S+x)*4;d[i]=clamp(d[i]*1.25);d[i+1]=clamp(d[i+1]*1.25);d[i+2]=clamp(d[i+2]*1.25);}
        else if(dist<4.5){const i=(y*S+x)*4;d[i]=clamp(d[i]*0.45);d[i+1]=clamp(d[i+1]*0.45);d[i+2]=clamp(d[i+2]*0.45);}
      }
      return d;
    }},
  // ---- DEEPSLATE ----
  {id:'deepslate',              name:'Deepslate',              cat:'Deepslate', sub:'Natural', gen:r=>grainGen(r,70,70,80,13)},
  {id:'cobbled_deepslate',      name:'Cobbled Deepslate',      cat:'Deepslate', sub:'Natural', gen:r=>cobbleGen(r,72,72,82)},
  {id:'polished_deepslate',     name:'Polished Deepslate',     cat:'Deepslate', sub:'Natural', gen:r=>flatNoise(r,82,82,92,7)},
  {id:'deepslate_bricks',       name:'Deepslate Bricks',       cat:'Deepslate', sub:'Brick', gen:r=>bricksGen(r,84,84,95,52,52,60)},
  {id:'mossy_deepslate_bricks', name:'Mossy Deepslate Bricks', cat:'Deepslate', sub:'Brick', gen:r=>{const d=bricksGen(r,84,84,95,52,52,60);applyMoss(d,r,0.28);return d;}},
  {id:'deepslate_tiles',        name:'Deepslate Tiles',        cat:'Deepslate', sub:'Brick', gen:r=>bricksGen(r,72,72,82,44,44,52,7,7,10)},
  {id:'cracked_deepslate_bricks',name:'Cracked Deepslate Bricks',cat:'Deepslate',sub:'Brick',gen:r=>{const d=bricksGen(r,84,84,95,52,52,60);applyCracks(d,r);return d;}},
  // ---- NETHER ----
  {id:'netherrack',             name:'Netherrack',             cat:'Nether',   sub:'Natural', gen:r=>flatNoise(r,110,40,40,16)},
  {id:'soul_sand',              name:'Soul Sand',              cat:'Nether',   sub:'Natural', gen:r=>specksNoise(r,68,54,42,48,38,30,0.07,14)},
  {id:'magma_block',            name:'Magma Block',            cat:'Nether',   sub:'Natural', gen:r=>specksNoise(r,100,42,14,180,90,18,0.1,14)},
  {id:'nether_wart_block',      name:'Nether Wart Block',      cat:'Nether',   sub:'Natural', gen:r=>flatNoise(r,118,22,22,16)},
  {id:'warped_wart_block',      name:'Warped Wart Block',      cat:'Nether',   sub:'Natural', gen:r=>flatNoise(r,22,118,108,16)},
  {id:'shroomlight',            name:'Shroomlight',            cat:'Nether',   sub:'Natural', gen:r=>flatNoise(r,254,218,80,16)},
  {id:'crimson_nylium',         name:'Crimson Nylium',         cat:'Nether',   sub:'Natural', gen:r=>crimsonNyliumGen(r)},
  {id:'basalt',                 name:'Basalt',                 cat:'Nether',   sub:'Basalt', gen:r=>grainGen(r,58,58,65,12)},
  {id:'polished_basalt',        name:'Polished Basalt',        cat:'Nether',   sub:'Basalt', gen:r=>grainGen(r,70,70,76,8)},
  {id:'blackstone',             name:'Blackstone',             cat:'Nether',   sub:'Blackstone', gen:r=>specksNoise(r,40,35,46,100,80,22,0.04,8)},
  {id:'polished_blackstone',    name:'Polished Blackstone',    cat:'Nether',   sub:'Blackstone', gen:r=>flatNoise(r,50,44,58,6)},
  {id:'polished_blackstone_bricks',name:'Polished Blackstone Bricks',cat:'Nether',sub:'Blackstone',gen:r=>bricksGen(r,55,48,62,32,28,38)},
  {id:'gilded_blackstone',      name:'Gilded Blackstone',      cat:'Nether',   sub:'Blackstone', gen:r=>specksNoise(r,40,35,46,200,158,28,0.1,8)},
  {id:'nether_bricks',          name:'Nether Bricks',          cat:'Nether',   sub:'Brick', gen:r=>bricksGen(r,46,24,24,28,14,14)},
  {id:'cracked_nether_bricks',  name:'Cracked Nether Bricks',  cat:'Nether',   sub:'Brick', gen:r=>{const d=bricksGen(r,46,24,24,28,14,14);applyCracks(d,r);return d;}},
  {id:'red_nether_bricks',      name:'Red Nether Bricks',      cat:'Nether',   sub:'Brick', gen:r=>bricksGen(r,78,22,22,52,14,14)},
  {id:'crimson_planks',         name:'Crimson Planks',         cat:'Nether',   sub:'Fungal', gen:r=>woodPlanks(r,101,32,50)},
  {id:'warped_planks',          name:'Warped Planks',          cat:'Nether',   sub:'Fungal', gen:r=>woodPlanks(r,43,104,101)},
  // ---- WOOD ----
  {id:'oak_planks',             name:'Oak Planks',             cat:'Wood',     sub:'Planks', gen:r=>woodPlanks(r,162,130,78)},
  {id:'dark_oak_planks',        name:'Dark Oak Planks',        cat:'Wood',     sub:'Planks', gen:r=>woodPlanks(r,66,43,20)},
  {id:'spruce_planks',          name:'Spruce Planks',          cat:'Wood',     sub:'Planks', gen:r=>woodPlanks(r,114,84,48)},
  {id:'birch_planks',           name:'Birch Planks',           cat:'Wood',     sub:'Planks', gen:r=>woodPlanks(r,216,194,118)},
  {id:'jungle_planks',          name:'Jungle Planks',          cat:'Wood',     sub:'Planks', gen:r=>woodPlanks(r,160,115,80)},
  {id:'acacia_planks',          name:'Acacia Planks',          cat:'Wood',     sub:'Planks', gen:r=>woodPlanks(r,168,90,50)},
  {id:'mangrove_planks',        name:'Mangrove Planks',        cat:'Wood',     sub:'Planks', gen:r=>woodPlanks(r,100,40,34)},
  {id:'cherry_planks',          name:'Cherry Planks',          cat:'Wood',     sub:'Planks', gen:r=>woodPlanks(r,228,168,168)},
  {id:'bamboo_planks',          name:'Bamboo Planks',          cat:'Wood',     sub:'Planks', gen:r=>woodPlanks(r,200,172,98)},
  {id:'pale_oak_planks',        name:'Pale Oak Planks',        cat:'Wood',     sub:'Planks', gen:r=>woodPlanks(r,228,220,205)},
  {id:'oak_log',                name:'Oak Log',                cat:'Wood',     sub:'Log Bark', gen:r=>logBarkGen(r,104,80,50)},
  {id:'dark_oak_log',           name:'Dark Oak Log',           cat:'Wood',     sub:'Log Bark', gen:r=>logBarkGen(r,44,32,16)},
  {id:'spruce_log',             name:'Spruce Log',             cat:'Wood',     sub:'Log Bark', gen:r=>logBarkGen(r,62,50,30)},
  {id:'birch_log',              name:'Birch Log',              cat:'Wood',     sub:'Log Bark', gen:r=>logBarkGen(r,202,196,162)},
  {id:'jungle_log',             name:'Jungle Log',             cat:'Wood',     sub:'Log Bark', gen:r=>logBarkGen(r,82,62,32)},
  {id:'acacia_log',             name:'Acacia Log',             cat:'Wood',     sub:'Log Bark', gen:r=>logBarkGen(r,90,72,38)},
  {id:'mangrove_log',           name:'Mangrove Log',           cat:'Wood',     sub:'Log Bark', gen:r=>logBarkGen(r,54,30,22)},
  {id:'cherry_log',             name:'Cherry Log',             cat:'Wood',     sub:'Log Bark', gen:r=>logBarkGen(r,84,54,50)},
  {id:'pale_oak_log',           name:'Pale Oak Log',           cat:'Wood',     sub:'Log Bark', gen:r=>logBarkGen(r,176,172,148)},
  {id:'oak_log_top',            name:'Oak Log Top',            cat:'Wood',     sub:'Log Top', gen:r=>logTopGen(r,104,80,50)},
  {id:'dark_oak_log_top',       name:'Dark Oak Log Top',       cat:'Wood',     sub:'Log Top', gen:r=>logTopGen(r,44,32,16)},
  {id:'spruce_log_top',         name:'Spruce Log Top',         cat:'Wood',     sub:'Log Top', gen:r=>logTopGen(r,62,50,30)},
  {id:'birch_log_top',          name:'Birch Log Top',          cat:'Wood',     sub:'Log Top', gen:r=>logTopGen(r,202,196,162)},
  {id:'jungle_log_top',         name:'Jungle Log Top',         cat:'Wood',     sub:'Log Top', gen:r=>logTopGen(r,82,62,32)},
  {id:'acacia_log_top',         name:'Acacia Log Top',         cat:'Wood',     sub:'Log Top', gen:r=>logTopGen(r,90,72,38)},
  {id:'mangrove_log_top',       name:'Mangrove Log Top',       cat:'Wood',     sub:'Log Top', gen:r=>logTopGen(r,54,30,22)},
  {id:'cherry_log_top',         name:'Cherry Log Top',         cat:'Wood',     sub:'Log Top', gen:r=>logTopGen(r,84,54,50)},
  {id:'pale_oak_log_top',       name:'Pale Oak Log Top',       cat:'Wood',     sub:'Log Top', gen:r=>logTopGen(r,176,172,148)},
  {id:'stripped_oak_log',       name:'Stripped Oak Log',       cat:'Wood',     sub:'Stripped', gen:r=>logBarkGen(r,162,128,80)},
  {id:'stripped_dark_oak_log',  name:'Stripped Dark Oak Log',  cat:'Wood',     sub:'Stripped', gen:r=>logBarkGen(r,60,38,18)},
  {id:'stripped_spruce_log',    name:'Stripped Spruce Log',    cat:'Wood',     sub:'Stripped', gen:r=>logBarkGen(r,98,74,42)},
  {id:'stripped_birch_log',     name:'Stripped Birch Log',     cat:'Wood',     sub:'Stripped', gen:r=>logBarkGen(r,190,172,122)},
  {id:'stripped_jungle_log',    name:'Stripped Jungle Log',    cat:'Wood',     sub:'Stripped', gen:r=>logBarkGen(r,136,100,62)},
  {id:'stripped_acacia_log',    name:'Stripped Acacia Log',    cat:'Wood',     sub:'Stripped', gen:r=>logBarkGen(r,166,98,56)},
  {id:'stripped_mangrove_log',  name:'Stripped Mangrove Log',  cat:'Wood',     sub:'Stripped', gen:r=>logBarkGen(r,102,44,36)},
  {id:'stripped_cherry_log',    name:'Stripped Cherry Log',    cat:'Wood',     sub:'Stripped', gen:r=>logBarkGen(r,188,136,120)},
  {id:'stripped_pale_oak_log',  name:'Stripped Pale Oak Log',  cat:'Wood',     sub:'Stripped', gen:r=>logBarkGen(r,224,216,200)},
  // ---- NATURE ----
  {id:'oak_leaves',             name:'Oak Leaves',             cat:'Nature',   sub:'Leaves', gen:r=>leavesGen(r,60,128,34)},
  {id:'dark_oak_leaves',        name:'Dark Oak Leaves',        cat:'Nature',   sub:'Leaves', gen:r=>leavesGen(r,40,78,24)},
  {id:'spruce_leaves',          name:'Spruce Leaves',          cat:'Nature',   sub:'Leaves', gen:r=>leavesGen(r,38,90,30)},
  {id:'birch_leaves',           name:'Birch Leaves',           cat:'Nature',   sub:'Leaves', gen:r=>leavesGen(r,80,120,54)},
  {id:'jungle_leaves',          name:'Jungle Leaves',          cat:'Nature',   sub:'Leaves', gen:r=>leavesGen(r,48,104,28)},
  {id:'mangrove_leaves',        name:'Mangrove Leaves',        cat:'Nature',   sub:'Leaves', gen:r=>leavesGen(r,72,120,42)},
  {id:'cherry_leaves',          name:'Cherry Leaves',          cat:'Nature',   sub:'Leaves', gen:r=>leavesGen(r,210,105,140)},
  {id:'azalea_leaves',          name:'Azalea Leaves',          cat:'Nature',   sub:'Leaves', gen:r=>azaleaLeavesGen(r)},
  {id:'grass_block',            name:'Grass Block',            cat:'Nature',   sub:'Ground', gen:r=>grassBlockGen(r)},
  {id:'coarse_dirt',            name:'Coarse Dirt',            cat:'Nature',   sub:'Ground', gen:r=>specksNoise(r,92,62,36,130,112,88,0.13,18)},
  {id:'podzol',                 name:'Podzol',                 cat:'Nature',   sub:'Ground', gen:r=>specksNoise(r,90,62,36,54,42,22,0.2,16)},
  {id:'mycelium',               name:'Mycelium',               cat:'Nature',   sub:'Ground', gen:r=>specksNoise(r,110,96,110,78,68,78,0.1,14)},
  {id:'moss_block',             name:'Moss Block',             cat:'Nature',   sub:'Ground', gen:r=>leavesGen(r,78,110,38)},
  // ---- TERRACOTTA ----
  {id:'terracotta',             name:'Terracotta',             cat:'Terracotta', gen:r=>flatNoise(r,152,94,67,16)},
  {id:'red_terracotta',         name:'Red Terracotta',         cat:'Terracotta', gen:r=>flatNoise(r,143,61,46,14)},
  {id:'orange_terracotta',      name:'Orange Terracotta',      cat:'Terracotta', gen:r=>flatNoise(r,162,84,38,15)},
  {id:'yellow_terracotta',      name:'Yellow Terracotta',      cat:'Terracotta', gen:r=>flatNoise(r,186,133,35,14)},
  {id:'lime_terracotta',        name:'Lime Terracotta',        cat:'Terracotta', gen:r=>flatNoise(r,103,117,52,13)},
  {id:'white_terracotta',       name:'White Terracotta',       cat:'Terracotta', gen:r=>flatNoise(r,209,177,161,12)},
  {id:'pink_terracotta',        name:'Pink Terracotta',        cat:'Terracotta', gen:r=>flatNoise(r,161,100,90,14)},
  {id:'brown_terracotta',       name:'Brown Terracotta',       cat:'Terracotta', gen:r=>flatNoise(r,77,51,36,12)},
  {id:'gray_terracotta',        name:'Gray Terracotta',        cat:'Terracotta', gen:r=>flatNoise(r,57,42,35,10)},
  // ---- MASONRY ----
  {id:'brick',                  name:'Brick',                  cat:'Masonry',  sub:'Brick', gen:r=>bricksGen(r,150,76,62,104,72,62)},
  {id:'mud_bricks',             name:'Mud Bricks',             cat:'Masonry',  sub:'Brick', gen:r=>bricksGen(r,128,100,74,90,68,50)},
  {id:'sandstone',              name:'Sandstone',              cat:'Masonry',  sub:'Sandstone', gen:r=>sandstoneGen(r,217,191,131)},
  {id:'red_sandstone',          name:'Red Sandstone',          cat:'Masonry',  sub:'Sandstone', gen:r=>sandstoneGen(r,183,110,56)},
  {id:'smooth_quartz',          name:'Smooth Quartz',          cat:'Masonry',  sub:'Quartz', gen:r=>flatNoise(r,230,228,220,6)},
  {id:'quartz_bricks',          name:'Quartz Bricks',          cat:'Masonry',  sub:'Quartz', gen:r=>bricksGen(r,233,228,222,196,192,188)},
  {id:'prismarine',             name:'Prismarine',             cat:'Masonry',  sub:'Ocean', gen:r=>prismarineGen(r)},
  {id:'prismarine_bricks',      name:'Prismarine Bricks',      cat:'Masonry',  sub:'Ocean', gen:r=>bricksGen(r,98,164,148,68,126,112)},
  {id:'dark_prismarine',        name:'Dark Prismarine',        cat:'Masonry',  sub:'Ocean', gen:r=>darkPrismarineGen(r)},
  // ---- END ----
  {id:'end_stone',              name:'End Stone',              cat:'End',      gen:r=>specksNoise(r,218,218,168,176,176,132,0.07,14)},
  {id:'end_stone_bricks',       name:'End Stone Bricks',       cat:'End',      gen:r=>bricksGen(r,218,218,168,176,176,132)},
  {id:'purpur_block',           name:'Purpur Block',           cat:'End',      gen:r=>specksNoise(r,160,90,158,128,68,126,0.08,12)},
  // ---- COPPER ----
  {id:'copper_block',           name:'Copper Block',           cat:'Copper',   gen:r=>flatNoise(r,196,120,70,18)},
  {id:'cut_copper',             name:'Cut Copper',             cat:'Copper',   gen:r=>bricksGen(r,190,110,65,148,82,48,7,7,12)},
  {id:'exposed_copper',         name:'Exposed Copper',         cat:'Copper',   gen:r=>specksNoise(r,162,116,80,100,130,100,0.15,14)},
  {id:'weathered_copper',       name:'Weathered Copper',       cat:'Copper',   gen:r=>specksNoise(r,100,140,100,82,162,138,0.15,14)},
  {id:'oxidized_copper',        name:'Oxidized Copper',        cat:'Copper',   gen:r=>oxidizedCopperGen(r)},
  // ---- SPECIAL ----
  {id:'packed_ice',             name:'Packed Ice',             cat:'Special',  sub:'Ice', gen:r=>flatNoise(r,160,196,240,12)},
  {id:'blue_ice',               name:'Blue Ice',               cat:'Special',  sub:'Ice', gen:r=>flatNoise(r,100,152,228,10)},
  {id:'obsidian',               name:'Obsidian',               cat:'Special',  sub:'Misc', gen:r=>specksNoise(r,14,10,20,40,30,55,0.06,5)},
  {id:'crying_obsidian',        name:'Crying Obsidian',        cat:'Special',  sub:'Misc', gen:r=>specksNoise(r,28,15,52,80,20,180,0.08,5)},
  {id:'amethyst_block',         name:'Amethyst Block',         cat:'Special',  sub:'Misc', gen:r=>flatNoise(r,126,82,200,20)},
  {id:'coal_block',             name:'Coal Block',             cat:'Special',  sub:'Misc', gen:r=>flatNoise(r,22,22,22,8)},
  {id:'bone_block',             name:'Bone Block',             cat:'Special',  sub:'Misc', gen:r=>grainGen(r,220,218,196,10)},
  {id:'honeycomb_block',        name:'Honeycomb Block',        cat:'Special',  sub:'Misc', gen:r=>flatNoise(r,218,152,30,16)},
  {id:'white_concrete',         name:'White Concrete',         cat:'Special',  sub:'Misc', gen:r=>flatNoise(r,207,213,214,5)},
  {id:'red_concrete',           name:'Red Concrete',           cat:'Special',  sub:'Misc', gen:r=>flatNoise(r,142,33,33,8)},
  // ---- MINERALS ----
  {id:'iron_block',             name:'Iron Block',             cat:'Minerals', gen:r=>flatNoise(r,196,196,196,8)},
  {id:'gold_block',             name:'Gold Block',             cat:'Minerals', gen:r=>flatNoise(r,240,196,40,18)},
  {id:'lapis_block',            name:'Lapis Block',            cat:'Minerals', gen:r=>flatNoise(r,32,64,168,14)},
  {id:'emerald_block',          name:'Emerald Block',          cat:'Minerals', gen:r=>flatNoise(r,44,172,88,16)},
  {id:'diamond_block',          name:'Diamond Block',          cat:'Minerals', gen:r=>flatNoise(r,78,214,220,16)},
  {id:'netherite_block',        name:'Netherite Block',        cat:'Minerals', gen:r=>flatNoise(r,45,44,46,8)},
];

// ============================================================
// TEXTURE CACHE
// ============================================================
const textureVariants = {};
function ensureVariants(blockId, count=32) {
  if (!textureVariants[blockId]) textureVariants[blockId] = [];
  const variants = textureVariants[blockId];
  const block = BLOCKS.find(b => b.id === blockId);
  if (!block) return variants;
  while (variants.length < count) {
    const seed = (blockId.split('').reduce((h,c)=>(h*31+c.charCodeAt(0))|0,0)>>>0) + variants.length*7919;
    const rng = mulberry32(seed);
    const pixels = block.gen(rng);
    const oc = new OffscreenCanvas(S,S);
    oc.getContext('2d').putImageData(new ImageData(pixels,S,S),0,0);
    variants.push(oc);
  }
  return variants;
}

// ============================================================
// REAL TEXTURE LOADING (minecraft-assets on GitHub, CORS-safe)
// ============================================================
const TEXTURE_BASE = 'https://raw.githubusercontent.com/InventivetalentDev/minecraft-assets/1.21.4/assets/minecraft/textures/block/';

// Maps block id → texture filename in the game's asset pack
const TEXTURE_FILENAMES = {
  stone:'stone.png', cobblestone:'cobblestone.png',
  mossy_cobblestone:'mossy_cobblestone.png', smooth_stone:'smooth_stone.png',
  stone_bricks:'stone_bricks.png', mossy_stone_bricks:'mossy_stone_bricks.png',
  cracked_stone_bricks:'cracked_stone_bricks.png', chiseled_stone_bricks:'chiseled_stone_bricks.png',
  andesite:'andesite.png', polished_andesite:'polished_andesite.png',
  diorite:'diorite.png', polished_diorite:'polished_diorite.png',
  granite:'granite.png', polished_granite:'polished_granite.png',
  deepslate:'deepslate.png', cobbled_deepslate:'cobbled_deepslate.png',
  polished_deepslate:'polished_deepslate.png', deepslate_bricks:'deepslate_bricks.png',
  mossy_deepslate_bricks:'mossy_deepslate_bricks.png', deepslate_tiles:'deepslate_tiles.png',
  cracked_deepslate_bricks:'cracked_deepslate_bricks.png',
  nether_bricks:'nether_bricks.png', cracked_nether_bricks:'cracked_nether_bricks.png',
  red_nether_bricks:'red_nether_bricks.png', blackstone:'blackstone.png',
  polished_blackstone:'polished_blackstone.png',
  polished_blackstone_bricks:'polished_blackstone_bricks.png',
  gilded_blackstone:'gilded_blackstone.png',
  crimson_planks:'crimson_planks.png', warped_planks:'warped_planks.png',
  crimson_nylium:'crimson_nylium.png',
  oak_planks:'oak_planks.png', dark_oak_planks:'dark_oak_planks.png',
  spruce_planks:'spruce_planks.png', birch_planks:'birch_planks.png',
  jungle_planks:'jungle_planks.png', acacia_planks:'acacia_planks.png',
  mangrove_planks:'mangrove_planks.png', cherry_planks:'cherry_planks.png',
  bamboo_planks:'bamboo_planks.png',
  oak_leaves:'oak_leaves.png', spruce_leaves:'spruce_leaves.png',
  azalea_leaves:'azalea_leaves.png',
  grass_block:'grass_block_side.png', coarse_dirt:'coarse_dirt.png',
  terracotta:'terracotta.png', red_terracotta:'red_terracotta.png',
  orange_terracotta:'orange_terracotta.png', yellow_terracotta:'yellow_terracotta.png',
  lime_terracotta:'lime_terracotta.png', white_terracotta:'white_terracotta.png',
  pink_terracotta:'pink_terracotta.png', brown_terracotta:'brown_terracotta.png',
  gray_terracotta:'gray_terracotta.png',
  brick:'bricks.png', quartz_bricks:'quartz_bricks.png',
  sandstone:'sandstone.png', red_sandstone:'red_sandstone.png',
  mud_bricks:'mud_bricks.png', prismarine:'prismarine.png',
  prismarine_bricks:'prismarine_bricks.png', dark_prismarine:'dark_prismarine.png',
  amethyst_block:'amethyst_block.png', obsidian:'obsidian.png',
  coal_block:'coal_block.png', copper_block:'copper_block.png',
  oxidized_copper:'oxidized_copper.png',
  white_concrete:'white_concrete.png', red_concrete:'red_concrete.png',
  tuff:'tuff.png', calcite:'calcite.png',
  polished_tuff:'polished_tuff.png', tuff_bricks:'tuff_bricks.png',
  chiseled_tuff:'chiseled_tuff.png', chiseled_tuff_bricks:'chiseled_tuff_bricks.png',
  netherrack:'netherrack.png', soul_sand:'soul_sand.png',
  basalt:'basalt_side.png', polished_basalt:'polished_basalt_side.png',
  magma_block:'magma.png', nether_wart_block:'nether_wart_block.png',
  warped_wart_block:'warped_wart_block.png', shroomlight:'shroomlight.png',
  pale_oak_planks:'pale_oak_planks.png',
  oak_log:'oak_log.png', dark_oak_log:'dark_oak_log.png',
  spruce_log:'spruce_log.png', birch_log:'birch_log.png',
  jungle_log:'jungle_log.png', acacia_log:'acacia_log.png',
  mangrove_log:'mangrove_log.png', cherry_log:'cherry_log.png',
  pale_oak_log:'pale_oak_log.png',
  oak_log_top:'oak_log_top.png', dark_oak_log_top:'dark_oak_log_top.png',
  spruce_log_top:'spruce_log_top.png', birch_log_top:'birch_log_top.png',
  jungle_log_top:'jungle_log_top.png', acacia_log_top:'acacia_log_top.png',
  mangrove_log_top:'mangrove_log_top.png', cherry_log_top:'cherry_log_top.png',
  pale_oak_log_top:'pale_oak_log_top.png',
  stripped_oak_log:'stripped_oak_log.png', stripped_dark_oak_log:'stripped_dark_oak_log.png',
  stripped_spruce_log:'stripped_spruce_log.png', stripped_birch_log:'stripped_birch_log.png',
  stripped_jungle_log:'stripped_jungle_log.png', stripped_acacia_log:'stripped_acacia_log.png',
  stripped_mangrove_log:'stripped_mangrove_log.png', stripped_cherry_log:'stripped_cherry_log.png',
  stripped_pale_oak_log:'stripped_pale_oak_log.png',
  dark_oak_leaves:'dark_oak_leaves.png', jungle_leaves:'jungle_leaves.png',
  birch_leaves:'birch_leaves.png', mangrove_leaves:'mangrove_leaves.png',
  cherry_leaves:'cherry_leaves.png', moss_block:'moss_block.png',
  podzol:'podzol_side.png', mycelium:'mycelium_side.png',
  end_stone:'end_stone.png', end_stone_bricks:'end_stone_bricks.png',
  purpur_block:'purpur_block.png', crying_obsidian:'crying_obsidian.png',
  bone_block:'bone_block_side.png', packed_ice:'packed_ice.png',
  blue_ice:'blue_ice.png', honeycomb_block:'honeycomb_block.png',
  cut_copper:'cut_copper.png', exposed_copper:'exposed_copper.png',
  weathered_copper:'weathered_copper.png', smooth_quartz:'smooth_quartz.png',
  iron_block:'iron_block.png', gold_block:'gold_block.png',
  lapis_block:'lapis_block.png', emerald_block:'emerald_block.png',
  diamond_block:'diamond_block.png', netherite_block:'netherite_block.png',
};

// Biome-color tints applied to leaf textures (they're greyscale in the raw assets)
// Values are [r,g,b] for a canvas 'multiply' composite over the loaded texture
const TEXTURE_TINTS = {
  oak_leaves:      [119, 171,  47],
  dark_oak_leaves: [119, 171,  47],
  jungle_leaves:   [ 72, 181,  24],
  birch_leaves:    [128, 167,  85],
  mangrove_leaves: [105, 172,  55],
  spruce_leaves:   [ 97, 153,  97],
  moss_block:      [109, 163,  52],
  // cherry_leaves and azalea_leaves have their own color — no tint
};

// Blocks with a directional grain that should NOT be randomly rotated
const NO_ROTATE = new Set([
  'oak_planks','dark_oak_planks','spruce_planks','birch_planks','jungle_planks',
  'acacia_planks','mangrove_planks','cherry_planks','bamboo_planks',
  'crimson_planks','warped_planks',
  'stone_bricks','mossy_stone_bricks','cracked_stone_bricks','chiseled_stone_bricks',
  'deepslate_bricks','mossy_deepslate_bricks','deepslate_tiles','cracked_deepslate_bricks',
  'nether_bricks','cracked_nether_bricks','red_nether_bricks',
  'polished_blackstone_bricks','brick','quartz_bricks','mud_bricks',
  'prismarine_bricks','sandstone','red_sandstone','grass_block',
  'tuff_bricks','chiseled_tuff','chiseled_tuff_bricks',
  'basalt','polished_basalt',
  'bone_block',
  'podzol','mycelium',
  'end_stone_bricks',
  'cut_copper',
  'oak_log','dark_oak_log','spruce_log','birch_log','jungle_log',
  'acacia_log','mangrove_log','cherry_log','pale_oak_log',
  'stripped_oak_log','stripped_dark_oak_log','stripped_spruce_log',
  'stripped_birch_log','stripped_jungle_log','stripped_acacia_log',
  'stripped_mangrove_log','stripped_cherry_log','stripped_pale_oak_log',
]);

// realTextures[blockId] = array of 8 OffscreenCanvases (4 rots × 2 flips)
// or 1-element array when rotation is suppressed
const realTextures = {};
const previewCanvases = {}; // blockId → <canvas> DOM element

let texLoadedCount = 0;
let texTotalCount = 0;
let renderScheduled = false;

function scheduleRender() {
  if (!renderScheduled) {
    renderScheduled = true;
    requestAnimationFrame(() => { renderScheduled = false; renderWall(); });
  }
}

function applyTint(ctx, tint) {
  if (!tint) return;
  ctx.setTransform(1, 0, 0, 1, 0, 0); // reset any active transform
  ctx.globalCompositeOperation = 'multiply';
  ctx.fillStyle = `rgb(${tint[0]},${tint[1]},${tint[2]})`;
  ctx.fillRect(0, 0, S, S);
  ctx.globalCompositeOperation = 'source-over';
}

function makeRotatedVariants(src, allowRotate, tint) {
  if (!allowRotate) {
    const oc = new OffscreenCanvas(S, S);
    const ctx = oc.getContext('2d');
    ctx.drawImage(src, 0, 0);
    applyTint(ctx, tint);
    return [oc];
  }
  const variants = [];
  for (let r = 0; r < 4; r++) {
    for (let f = 0; f < 2; f++) {
      const oc = new OffscreenCanvas(S, S);
      const ctx = oc.getContext('2d');
      ctx.translate(S / 2, S / 2);
      ctx.rotate(r * Math.PI / 2);
      if (f) ctx.scale(-1, 1);
      ctx.drawImage(src, -S / 2, -S / 2, S, S);
      applyTint(ctx, tint);
      variants.push(oc);
    }
  }
  return variants; // 8 entries
}

function updateBlockPreview(id) {
  const cvs = previewCanvases[id];
  if (!cvs || !realTextures[id]) return;
  const ctx = cvs.getContext('2d');
  ctx.imageSmoothingEnabled = false;
  ctx.clearRect(0, 0, 24, 24);
  ctx.drawImage(realTextures[id][0], 0, 0, 24, 24);
  // also update summary row preview if visible
  const summaryRow = document.querySelector(`.summary-row[data-summary-for="${id}"]`);
  if (summaryRow) {
    const cc = summaryRow.querySelector('canvas');
    if (cc) { const cx = cc.getContext('2d'); cx.imageSmoothingEnabled = false; cx.drawImage(realTextures[id][0], 0, 0, 20, 20); }
  }
}

function updateTexStatus() {
  const el = document.getElementById('texStatus');
  if (el) el.textContent = texLoadedCount < texTotalCount
    ? `Loading textures… ${texLoadedCount}/${texTotalCount}`
    : `${texLoadedCount}/${texTotalCount} textures`;
}

function loadRealTextures() {
  const ids = BLOCKS.map(b => b.id).filter(id => TEXTURE_FILENAMES[id]);
  texTotalCount = ids.length;
  texLoadedCount = 0;
  updateTexStatus();

  for (const id of ids) {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      realTextures[id] = makeRotatedVariants(img, !NO_ROTATE.has(id), TEXTURE_TINTS[id]);
      texLoadedCount++;
      updateBlockPreview(id);
      updateTexStatus();
      scheduleRender();
    };
    img.onerror = () => { texLoadedCount++; updateTexStatus(); };
    img.src = TEXTURE_BASE + TEXTURE_FILENAMES[id];
  }
}

// ============================================================
// PALETTE PERCENTAGE MANAGEMENT
// All values in state.palette are integers summing to 100
// ============================================================

// Convert any weight map → integer percentages summing to 100
function normalizeToPercentages(weights) {
  const entries = Object.entries(weights).filter(([,v]) => v > 0);
  if (entries.length === 0) return {};
  const total = entries.reduce((s,[,v])=>s+v, 0);
  const result = {};
  let assigned = 0;
  for (let i = 0; i < entries.length - 1; i++) {
    const [id, v] = entries[i];
    result[id] = Math.max(1, Math.round(v / total * 100));
    assigned += result[id];
  }
  result[entries[entries.length-1][0]] = Math.max(1, 100 - assigned);
  return result;
}

// Redistribute so changedId has newPct; locked blocks stay fixed, others share the rest proportionally
function redistributeFrom(changedId, newPct) {
  const locked  = Object.keys(state.palette).filter(k => k !== changedId && state.locks.has(k));
  const free    = Object.keys(state.palette).filter(k => k !== changedId && !state.locks.has(k));
  if (free.length === 0 && locked.length === 0) { state.palette[changedId] = 100; return; }
  const lockedTotal = locked.reduce((s,k) => s + state.palette[k], 0);
  // Clamp so every free block keeps at least 1% and locked blocks keep their current values
  newPct = Math.max(1, Math.min(100 - lockedTotal - free.length, newPct));
  const remaining = 100 - newPct - lockedTotal;
  const freeTotal = free.reduce((s,k) => s + state.palette[k], 0);
  state.palette[changedId] = newPct;
  if (free.length === 0) return; // only locked others — nothing to redistribute
  if (freeTotal === 0) {
    const base = Math.floor(remaining / free.length);
    const extra = remaining - base * free.length;
    free.forEach((k,i) => { state.palette[k] = base + (i < extra ? 1 : 0); });
  } else {
    let assigned = 0;
    for (let i = 0; i < free.length - 1; i++) {
      const k = free[i];
      state.palette[k] = Math.max(1, Math.round((state.palette[k] / freeTotal) * remaining));
      assigned += state.palette[k];
    }
    state.palette[free[free.length-1]] = Math.max(1, remaining - assigned);
  }
  // Guarantee sum = 100, spreading any rounding error across free blocks
  let diff = 100 - Object.values(state.palette).reduce((s,v)=>s+v, 0);
  if (diff < 0) {
    for (let i = free.length - 1; i >= 0 && diff < 0; i--) {
      if (state.palette[free[i]] > 1) { state.palette[free[i]]--; diff++; }
    }
  } else if (diff > 0) {
    state.palette[free[free.length-1]] += diff;
  }
}

// Add block, take equal share from all (including new)
function addBlockToPalette(id) {
  state.palette[id] = 0;
  const keys = Object.keys(state.palette);
  const n = keys.length;
  const base = Math.floor(100 / n);
  const extra = 100 - base * n;
  keys.forEach((k, i) => { state.palette[k] = base + (i < extra ? 1 : 0); });
}

// Remove block, distribute its % proportionally to remaining
function removeBlockFromPalette(id) {
  const pct = state.palette[id];
  delete state.palette[id];
  const remaining = Object.keys(state.palette);
  if (remaining.length === 0) return;
  const currentTotal = remaining.reduce((s,k)=>s+state.palette[k],0);
  if (currentTotal === 0) {
    const base = Math.floor(100 / remaining.length);
    const extra = 100 - base * remaining.length;
    remaining.forEach((k,i) => { state.palette[k] = base + (i < extra ? 1 : 0); });
  } else {
    let assigned = 0;
    for (let i = 0; i < remaining.length - 1; i++) {
      const k = remaining[i];
      state.palette[k] = Math.max(1, Math.round((state.palette[k] / currentTotal) * 100));
      assigned += state.palette[k];
    }
    state.palette[remaining[remaining.length-1]] = Math.max(1, 100 - assigned);
  }
}

const SVG_LOCKED   = `<svg width="11" height="13" viewBox="0 0 11 13" fill="none"><rect x="1" y="5.5" width="9" height="7" rx="1.5" fill="currentColor"/><path d="M2.5 5.5V3.5a3 3 0 0 1 6 0v2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>`;
const SVG_UNLOCKED = `<svg width="11" height="13" viewBox="0 0 11 13" fill="none"><rect x="1" y="5.5" width="9" height="7" rx="1.5" fill="currentColor"/><path d="M8.5 5.5V3.5a3 3 0 0 0-6 0" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>`;

function toggleLock(id) {
  if (state.locks.has(id)) { state.locks.delete(id); } else { state.locks.add(id); }
  const locked = state.locks.has(id);
  document.querySelectorAll(`[data-lock-for="${id}"]`).forEach(btn => {
    btn.innerHTML = locked ? SVG_LOCKED : SVG_UNLOCKED;
    btn.classList.toggle('locked', locked);
  });
}

// Sync all slider DOM elements to current state.palette values
function syncSliders() {
  const n = Object.keys(state.palette).length;
  for (const [id, pct] of Object.entries(state.palette)) {
    document.querySelectorAll(`input[data-pct-for="${id}"]`).forEach(slider => {
      slider.value = pct; slider.max = 100 - Math.max(0, n - 1);
    });
    document.querySelectorAll(`span[data-pct-display="${id}"]`).forEach(display => {
      display.textContent = pct + '%';
    });
  }
}

// ============================================================
// STATE & PRESETS
// ============================================================
const BLOCK_SIZES = [16, 24, 32, 48, 64];

const PRESETS = {
  dungeon:              {cobblestone:4,mossy_cobblestone:3,stone_bricks:4,mossy_stone_bricks:2,cracked_stone_bricks:1},
  nether_fortress:      {nether_bricks:4,cracked_nether_bricks:2,red_nether_bricks:1,blackstone:1},
  deepslate_cave:       {cobbled_deepslate:4,deepslate_bricks:3,deepslate:2,deepslate_tiles:2,cracked_deepslate_bricks:1},
  desert_temple:        {sandstone:5,red_sandstone:3,smooth_stone:1},
  ocean_monument:       {prismarine:4,prismarine_bricks:3,dark_prismarine:2},
  polished_mix:         {polished_andesite:3,polished_diorite:3,polished_granite:3,polished_blackstone:1},
  mossy_ruin:           {mossy_cobblestone:5,mossy_stone_bricks:5,mossy_deepslate_bricks:2,cracked_stone_bricks:2},
  back_from_the_mines:  {cobblestone:3,mossy_cobblestone:2,red_concrete:2,dark_oak_planks:2},
  overgrown_path:       {oak_leaves:3,cobblestone:2,mossy_cobblestone:2,coarse_dirt:2},
  woodcutter:           {dark_oak_planks:4,oak_planks:3,oak_leaves:2},
  grove_of_ashes:       {grass_block:2,stone:3,oak_planks:2,pink_terracotta:1},
  ghost_valley:         {red_terracotta:3,dark_oak_planks:3,terracotta:2,grass_block:1},
  italian_path:         {sandstone:3,spruce_planks:2,smooth_stone:3,cobblestone:2},
  undergrove:           {amethyst_block:3,oak_leaves:2,crimson_nylium:2,obsidian:1},
  barrel_roll:          {oak_leaves:2,oak_planks:3,amethyst_block:2,cherry_planks:2},
  old_garage:           {dark_oak_planks:3,cobblestone:3,deepslate_bricks:2,smooth_stone:2},
  rusty_roof:           {dark_oak_planks:3,oxidized_copper:3,copper_block:2},
  warmer_wood:          {brick:3,dark_oak_planks:3,granite:2,pink_terracotta:1},
  coal_house:           {sandstone:3,coal_block:2,spruce_planks:3,stone_bricks:1},
  magical_fungi:        {amethyst_block:2,orange_terracotta:2,crimson_nylium:2,obsidian:2},
  candy_leaves:         {azalea_leaves:3,birch_planks:2,amethyst_block:1,cherry_planks:2},
  cabin_shower:         {deepslate_bricks:3,dark_oak_planks:3,smooth_stone:2,white_terracotta:1},
  steampunk_blacksmith: {dark_oak_planks:3,oxidized_copper:3,coal_block:2,copper_block:1},
  mumbo_mountain:       {brick:3,granite:3,terracotta:2,red_terracotta:1},
  meadow_in_the_city:   {brick:3,white_concrete:2,oak_leaves:3,cobblestone:1},
  end_city:             {purpur_block:4,end_stone_bricks:3,end_stone:2,crying_obsidian:1},
  ice_palace:           {packed_ice:3,blue_ice:4,white_concrete:2},
  basalt_delta:         {basalt:4,polished_basalt:3,blackstone:2,nether_bricks:1},
  tuff_tower:           {tuff_bricks:3,polished_tuff:2,tuff:2,cobblestone:1},
  mushroom_house:       {nether_wart_block:3,warped_wart_block:3,shroomlight:1,crimson_nylium:2},
  golden_palace:        {gold_block:3,honeycomb_block:3,iron_block:2,smooth_quartz:1},
};

let state = {
  seed:         Math.floor(Math.random() * 0xFFFFFFFF),
  width:        12,
  height:       8,
  blockSizeIdx: 3,
  showCoords:   true,
  palette:      normalizeToPercentages({cobblestone:3,mossy_cobblestone:2,stone_bricks:3,mossy_stone_bricks:2}),
  locks:        new Set(), // block IDs whose percentage is pinned
};

function getBlockSize() { return BLOCK_SIZES[state.blockSizeIdx]; }

function buildWeightedPalette() {
  // Percentages sum to 100, so weighted array has exactly 100 entries
  const arr = [];
  for (const [id, pct] of Object.entries(state.palette))
    for (let i=0; i<pct; i++) arr.push(id);
  return arr;
}

// ============================================================
// RENDERING
// ============================================================
function renderWall() {
  const canvas = document.getElementById('wall-canvas');
  const emptyMsg = document.getElementById('empty-msg');
  const bs = getBlockSize();
  const palette = buildWeightedPalette();

  if (palette.length === 0) {
    canvas.style.display = 'none';
    emptyMsg.style.display = 'block';
    return;
  }
  canvas.style.display = 'block';
  emptyMsg.style.display = 'none';

  // Gutter sizing (computed before canvas resize)
  const fontSize = Math.max(9, Math.min(Math.floor(bs * 0.33), 15));
  const gutterTop  = state.showCoords ? fontSize + 8 : 0;
  // Approximate monospace char width to avoid needing a context first
  const gutterLeft = state.showCoords ? Math.ceil(String(state.height).length * fontSize * 0.65) + 10 : 0;

  canvas.width  = state.width  * bs + gutterLeft;
  canvas.height = state.height * bs + gutterTop;
  const ctx = canvas.getContext('2d');
  ctx.imageSmoothingEnabled = false;

  // Draw gutter background
  if (state.showCoords) {
    ctx.fillStyle = '#141414';
    ctx.fillRect(0, 0, canvas.width, gutterTop);          // top strip
    ctx.fillRect(0, gutterTop, gutterLeft, canvas.height); // left strip

    ctx.font = `bold ${fontSize}px monospace`;
    ctx.fillStyle = '#666';

    // Column numbers centred above each column
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    for (let col = 0; col < state.width; col++) {
      ctx.fillText(String(col + 1), gutterLeft + col * bs + bs / 2, gutterTop / 2);
    }

    // Row numbers centred beside each row
    ctx.textAlign = 'center';
    for (let row = 0; row < state.height; row++) {
      ctx.fillText(String(row + 1), gutterLeft / 2, gutterTop + row * bs + bs / 2);
    }
  }

  const rng = mulberry32(state.seed);
  for (let row=0; row<state.height; row++) {
    for (let col=0; col<state.width; col++) {
      const blockId = palette[Math.floor(rng() * palette.length)];
      // Always consume 2 rng calls per cell so seed is stable regardless of texture source
      const variantVal = rng();
      const variants = realTextures[blockId] ?? ensureVariants(blockId, 32);
      ctx.drawImage(variants[Math.floor(variantVal * variants.length)], gutterLeft + col*bs, gutterTop + row*bs, bs, bs);
    }
  }

  document.getElementById('seedInput').value = state.seed.toString(16).toUpperCase().padStart(8,'0');
  document.getElementById('canvasInfo').textContent =
    `${state.width} × ${state.height} blocks  •  ${canvas.width} × ${canvas.height}px  •  seed: ${state.seed.toString(16).toUpperCase()}`;
}

// ============================================================
// PALETTE UI
// ============================================================
const CATEGORIES_ORDER = ['Stone','Deepslate','Nether','Wood','Nature','Terracotta','Masonry','End','Copper','Special','Minerals'];

function updateSelectedSummary() {
  const panel = document.getElementById('selectedSummary');
  const list = document.getElementById('summaryChips');
  const ids = Object.keys(state.palette);
  if (ids.length === 0) { panel.style.display = 'none'; return; }
  panel.style.display = 'block';
  list.innerHTML = '';
  const n = ids.length;
  for (const id of ids) {
    const block = BLOCKS.find(b => b.id === id);
    if (!block) continue;

    const row = document.createElement('div');
    row.className = 'summary-row';
    row.dataset.summaryFor = id;

    // top: thumbnail + name + pct
    const top = document.createElement('div');
    top.className = 'summary-row-top';

    const cv = document.createElement('canvas');
    cv.width = 20; cv.height = 20;
    cv.className = 'summary-preview';
    requestAnimationFrame(() => {
      const pc = cv.getContext('2d');
      pc.imageSmoothingEnabled = false;
      const src = realTextures[id] ? realTextures[id][0] : ensureVariants(id, 1)[0];
      pc.drawImage(src, 0, 0, 20, 20);
    });

    const nameEl = document.createElement('span');
    nameEl.className = 'summary-row-name';
    nameEl.textContent = block.name;

    const pctEl = document.createElement('span');
    pctEl.className = 'pct-display';
    pctEl.dataset.pctDisplay = id;
    pctEl.textContent = state.palette[id] + '%';

    const lockBtn = document.createElement('button');
    lockBtn.className = 'lock-btn' + (state.locks.has(id) ? ' locked' : '');
    lockBtn.title = 'Lock percentage';
    lockBtn.innerHTML = state.locks.has(id) ? SVG_LOCKED : SVG_UNLOCKED;
    lockBtn.dataset.lockFor = id;
    lockBtn.addEventListener('click', () => toggleLock(id));

    top.appendChild(cv);
    top.appendChild(nameEl);
    top.appendChild(pctEl);
    top.appendChild(lockBtn);

    // slider
    const slider = document.createElement('input');
    slider.type = 'range';
    slider.className = 'pct-slider summary-slider';
    slider.min = 1;
    slider.max = 100 - Math.max(0, n - 1);
    slider.value = state.palette[id];
    slider.dataset.pctFor = id;
    slider.addEventListener('input', () => {
      redistributeFrom(id, parseInt(slider.value));
      syncSliders();
      renderWall();
    });

    row.appendChild(top);
    row.appendChild(slider);
    list.appendChild(row);
  }
}

function buildPaletteUI() {
  const container = document.getElementById('paletteContainer');
  container.innerHTML = '';
  const grouped = {};
  for (const b of BLOCKS) { if (!grouped[b.cat]) grouped[b.cat]=[]; grouped[b.cat].push(b); }

  for (const catName of CATEGORIES_ORDER) {
    const blocks = grouped[catName] || [];
    if (!blocks.length) continue;

    const section = document.createElement('div');
    section.className = 'category';

    const header = document.createElement('div');
    header.className = 'category-header';
    const arrow = document.createElement('span');
    arrow.className = 'cat-arrow';
    const countSpan = document.createElement('span');
    countSpan.className = 'cat-count';

    header.appendChild(arrow);
    header.appendChild(document.createTextNode(catName));
    header.appendChild(countSpan);

    const list = document.createElement('div');
    list.className = 'block-list';

    const collapsed = !['Stone','Deepslate'].includes(catName);
    list.classList.toggle('collapsed', collapsed);
    arrow.textContent = collapsed ? '►' : '▼';

    header.addEventListener('click', () => {
      list.classList.toggle('collapsed');
      arrow.textContent = list.classList.contains('collapsed') ? '►' : '▼';
    });

    // Group by sub-category, preserving insertion order
    const hasSubs = blocks.some(b => b.sub);
    if (hasSubs) {
      const subGroups = [];
      const subMap = {};
      for (const b of blocks) {
        const sub = b.sub || '';
        if (!subMap[sub]) { subMap[sub] = []; subGroups.push([sub, subMap[sub]]); }
        subMap[sub].push(b);
      }
      for (const [subName, subBlocks] of subGroups) {
        if (subName) {
          const subHeader = document.createElement('div');
          subHeader.className = 'subcat-header';
          subHeader.textContent = subName;
          list.appendChild(subHeader);
        }
        for (const block of subBlocks) list.appendChild(createBlockRow(block, blocks, countSpan));
      }
    } else {
      for (const block of blocks) list.appendChild(createBlockRow(block, blocks, countSpan));
    }
    updateCatCount(blocks, countSpan);

    section.appendChild(header);
    section.appendChild(list);
    container.appendChild(section);
  }
  updateSelectedSummary();
}

function updateCatCount(blocks, countSpan) {
  const sel = blocks.filter(b => b.id in state.palette).length;
  countSpan.textContent = sel > 0 ? `${sel}/${blocks.length}` : '';
}

function createBlockRow(block, catBlocks, catCountSpan) {
  const row = document.createElement('div');
  row.className = 'block-row' + (block.id in state.palette ? ' selected' : '');

  // --- Top row: preview + checkbox + name + pct ---
  const top = document.createElement('div');
  top.className = 'block-row-top';

  const preview = document.createElement('canvas');
  preview.width = 24; preview.height = 24;
  preview.className = 'block-preview';
  previewCanvases[block.id] = preview;
  requestAnimationFrame(() => {
    const pc = preview.getContext('2d');
    pc.imageSmoothingEnabled = false;
    const src = realTextures[block.id] ? realTextures[block.id][0] : ensureVariants(block.id, 1)[0];
    pc.drawImage(src, 0, 0, 24, 24);
  });

  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.checked = block.id in state.palette;

  const nameEl = document.createElement('span');
  nameEl.className = 'block-name';
  nameEl.textContent = block.name;

  const pctDisplay = document.createElement('span');
  pctDisplay.className = 'pct-display';
  pctDisplay.dataset.pctDisplay = block.id;
  pctDisplay.textContent = (state.palette[block.id] ?? 0) + '%';
  pctDisplay.style.visibility = block.id in state.palette ? 'visible' : 'hidden';

  const lockBtn = document.createElement('button');
  lockBtn.className = 'lock-btn' + (state.locks.has(block.id) ? ' locked' : '');
  lockBtn.title = 'Lock percentage';
  lockBtn.innerHTML = state.locks.has(block.id) ? SVG_LOCKED : SVG_UNLOCKED;
  lockBtn.dataset.lockFor = block.id;
  lockBtn.addEventListener('click', e => { e.stopPropagation(); toggleLock(block.id); });

  top.appendChild(preview);
  top.appendChild(checkbox);
  top.appendChild(nameEl);
  top.appendChild(pctDisplay);
  top.appendChild(lockBtn);

  // --- Slider row ---
  const sliderWrap = document.createElement('div');
  sliderWrap.className = 'block-slider-wrap';

  const slider = document.createElement('input');
  slider.type = 'range';
  slider.className = 'pct-slider';
  slider.min = 1;
  slider.max = 99;
  slider.value = state.palette[block.id] ?? 50;
  slider.dataset.pctFor = block.id;

  sliderWrap.appendChild(slider);

  // --- Events ---
  slider.addEventListener('input', () => {
    redistributeFrom(block.id, parseInt(slider.value));
    syncSliders();
    renderWall();
  });

  function toggle(on) {
    if (on === (block.id in state.palette)) return;
    if (on) {
      addBlockToPalette(block.id);
      row.classList.add('selected');
      pctDisplay.style.visibility = 'visible';
    } else {
      state.locks.delete(block.id);
      lockBtn.classList.remove('locked');
      lockBtn.innerHTML = SVG_UNLOCKED;
      removeBlockFromPalette(block.id);
      row.classList.remove('selected');
      pctDisplay.style.visibility = 'hidden';
    }
    checkbox.checked = on;
    syncSliders();
    updateCatCount(catBlocks, catCountSpan);
    updateSelectedSummary();
    renderWall();
  }

  checkbox.addEventListener('change', () => toggle(checkbox.checked));
  [preview, nameEl].forEach(el => el.addEventListener('click', () => toggle(!(block.id in state.palette))));

  row.appendChild(top);
  row.appendChild(sliderWrap);
  return row;
}

// ============================================================
// EVENT LISTENERS
// ============================================================
function setupEventListeners() {
  document.getElementById('btnRandomize').addEventListener('click', () => {
    state.seed = Math.floor(Math.random() * 0xFFFFFFFF);
    renderWall();
  });

  document.getElementById('btnExport').addEventListener('click', () => {
    const a = document.createElement('a');
    a.download = `blockwork-${state.seed.toString(16).toUpperCase()}.png`;
    a.href = document.getElementById('wall-canvas').toDataURL('image/png');
    a.click();
  });
  document.getElementById('widthInput').addEventListener('input', e => {
    state.width = Math.max(1, Math.min(64, parseInt(e.target.value)||1));
    renderWall();
  });
  document.getElementById('heightInput').addEventListener('input', e => {
    state.height = Math.max(1, Math.min(32, parseInt(e.target.value)||1));
    renderWall();
  });
  const ZOOM_LABELS = ['1×', '1.5×', '2×', '3×', '4×'];
  const bsr = document.getElementById('blockSizeRange');
  bsr.value = state.blockSizeIdx; // sync slider to default
  bsr.addEventListener('input', () => {
    state.blockSizeIdx = parseInt(bsr.value);
    document.getElementById('blockSizeVal').textContent = ZOOM_LABELS[state.blockSizeIdx];
    renderWall();
  });
  document.getElementById('coordsToggle').addEventListener('change', e => {
    state.showCoords = e.target.checked;
    renderWall();
  });
  document.getElementById('seedInput').addEventListener('change', e => {
    const val = parseInt(e.target.value.trim(), 16);
    if (!isNaN(val)) { state.seed = val >>> 0; renderWall(); }
  });
  document.getElementById('presetSelect').addEventListener('change', e => {
    const preset = PRESETS[e.target.value];
    if (!preset) return;
    state.palette = normalizeToPercentages(preset);
    state.locks.clear();
    buildPaletteUI(); // calls updateSelectedSummary internally
    renderWall();
    e.target.value = '';
  });
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  buildPaletteUI();
  setupEventListeners();
  renderWall();
  loadRealTextures(); // fetches real textures in background, re-renders as they arrive
});
</script>
</body>
</html>
